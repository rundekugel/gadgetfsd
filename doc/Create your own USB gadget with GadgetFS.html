<html xmlns="http://www.w3.org/1999/xhtml" xmlns:dyn="http://indefero.soutade.fr/p/dynastie"><head>
    <meta content="text/html; charset=UTF-8" http-equiv="content-type">
    <meta content="index, follow" name="robots">
    <meta content="Tutorial to create your own USB gadget with GadgetFS on Linux. How to send raw BULK packets." name="description">
    <meta content="USB, GadgetFS, BULK, Linux, raw, tutorial, tutoriel" name="keywords">
    <meta content="Create your own USB gadget with GadgetFS" name="title">
    <meta content="Grégory Soutadé" name="author">
    <meta content="Dynastie" name="generator">
    <meta content="width=width, initial-scale=1" name="viewport">
    <title>Create your own USB gadget with GadgetFS</title>
    <link href="https://blog.soutade.fr/images/favicon.png" rel="icon" type="image/png">
    <link href="https://blog.soutade.fr/rss.xml" rel="alternate" title="RSS 2.0" type="application/rss+xml">
    <link href="https://blog.soutade.fr/atom.xml" rel="alternate" title="Atom 1.0" type="application/atom+xml">
    <link href="Create%20your%20own%20USB%20gadget%20with%20GadgetFS-Dateien/blog.css" rel="stylesheet" type="text/css">
    <script src="Create%20your%20own%20USB%20gadget%20with%20GadgetFS-Dateien/blog.js" type="text/javascript"> </script>
  </head>
  <body onload="javascript:init();">
    <div class="content" id="content">
      <header>
	<div id="header">
	  <h2 id="title"><a href="https://blog.soutade.fr/">Blog de Grégory Soutadé</a></h2>
	</div>
      </header>
      
    <div class="post">
      <article>
	<div class="post">
	  <header>
	    <div class="post_header">
	      <div class="title">Create your own USB gadget with GadgetFS</div>
	      <div class="post_sub_header">
		<div class="date">Monday, 25 July 2016</div> | <div class="author_icon"> Écrit par <div class="author">Grégory Soutadé</div> </div>
	      </div>
	      <div class="tags"><div class="tag"><a href="https://blog.soutade.fr/tag/programmation">#Programmation</a></div><div class="tag"><a href="https://blog.soutade.fr/tag/inenglish">#InEnglish</a></div></div>
	    </div>
	  </header>
	  <div class="post_content"><p>Do It Yourself, make your own objects, 
this is in vogue. Since the first version RaspberryPI, we can see a lot 
of little boards with GPIO connections that handles basic 
sensors/connectors. Even if some prefer to use wireless communications 
to communicate with these little devices, USB is still there !</p>

<p>Today I'll show an example of a basic raw bulk USB communication. We could setup our device with the serial line gadget (<em>/dev/ttyGS0</em>),
 but if you need performance or you want to handle specific USB feature,
 it's interesting to use raw transfers. Plus, all of this is done in 
userspace thanks to GadgetFS.</p>

<p>I waste a lot of time due to a buggy USB driver (dwc2), but, finally, the right code is simple.</p>

<h2>1. USB keywords</h2>

<p>All technical details about USB can be found within <a href="http://www.usb.org/home">usb.org</a> or <a href="http://www.linux-usb.org/">linux-usb.org</a>, it's quite heavy. Basically, USB communication use a master/slave schema : <strong>host</strong> side (mainly a PC) sends requests to <strong>device</strong> side (device). Device never asks questions, it only replies.</p>

<p>Configuration of USB port can be static (host or device) or dynamic. 
This is the case for DRD (Dual Role Device) configurations, which was 
previously called OTG (On The Go : who is the first to talk ?).</p>

<p>On the device, we have endpoints grouped into interfaces. Each 
endpoint contains a hardware buffer (memory) to deal with requests. An 
endpoint is setup (hardcoded) to be <em>in</em> or <em>out</em>, meaning, it can do only "in" or "out" operation.</p>

<p>In addition to direction, the type of endpoint is important (it's assigned during endpoint configuration). It can be :</p>

<ul>
<li><em>control</em> for configuration/control requests</li>
<li><em>bulk</em> for bulk transfers</li>
<li><em>isochronous</em> for periodic transfers with a reserved bandwidth</li>
<li><em>int</em> for transfers by interruption</li>
</ul>

<p>A special endpoint called <em>ep0</em> (the first one) is always present. It's an <em>in</em> <strong>and</strong> <em>out</em> endpoint with <em>control</em> attribute. It allows to read/write configuration of other endpoints.</p>

<p>All these information are described in <em>descriptors</em>. You can look at them with</p>

<pre><code>lsusb -v
</code></pre>

<p>The low level command sent to controller is called an URB (USB Request Block).</p>

<p>A picture to sum up :</p>

<p><img src="Create%20your%20own%20USB%20gadget%20with%20GadgetFS-Dateien/usb.png" alt="USB host/device schema"></p>

<h2>2. Enable and mount GadgetFS</h2>

<p>First thing to do is to enable GadgetFS in the kernel you're running (if it's not already the case).</p>

<p>Run <em>make menuconfig [ARCH=XXX]</em> in the kernel build directory. Then, enable</p>

<pre><code>Device Drivers -&gt; USB support -&gt; USB Gadget Support -&gt; USB Gadget Drivers -&gt; Gadget Filesystem
</code></pre>

<p>In the same section (or in the section above depending on your controller), select the right <em>Peripheral Controller</em>.</p>

<p>You can now rebuild your Linux kernel.</p>

<p>Once booted, mount GadgetFS (in <em>/dev</em> for example)</p>

<pre><code>mkdir /dev/gadget
mount -t gadgetfs gadgetfs /dev/gadget
</code></pre>

<h2>3. Device side</h2>

<p>There is a reference code that can be found in <a href="http://www.linux-usb.org/gadget/">linux-usb.org</a> which manage everything and can use aio for asynchronous requests management. Mine is simpler, full code link can be found in <em>Conclusion</em> part. I'll explain each parts in details.</p>

<p>Let's start. Do includes. <em>usbtring.c</em> is copied from 
linux-usb.org (strings sent back to host must be encoded in UTF-16). 
Most of structures and defines are referenced in <a href="http://lxr.free-electrons.com/source/include/uapi/linux/usb/ch9.h">ch9.h</a> (which corresponds to chapter 9 of the USB norm) and <a href="http://lxr.free-electrons.com/source/include/uapi/linux/usb/gadgetfs.h">gadgetfs.h</a></p>

<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/select.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;linux/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/usb/ch9.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/usb/gadgetfs.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pthread.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;errno.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">"usbstring.c"</span><span class="cp"></span>
</code></pre></div>

<p>Then, defines</p>

<div class="codehilite"><pre><span></span><code><span class="cp">#define FETCH(_var_)                            \</span>
<span class="cp">    memcpy(cp, &amp;_var_, _var_.bLength);          \</span>
<span class="cp">    cp += _var_.bLength;</span>

<span class="cp">#define CONFIG_VALUE 2</span>

<span class="c1">// Specific to controller</span>
<span class="cp">#define USB_DEV "/dev/gadget/dwc2"</span>
<span class="cp">#define USB_EPIN "/dev/gadget/ep1in"</span>
<span class="cp">#define USB_EPOUT "/dev/gadget/ep2out"</span>

<span class="k">enum</span> <span class="p">{</span>
    <span class="n">STRINGID_MANUFACTURER</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">STRINGID_PRODUCT</span><span class="p">,</span>
    <span class="n">STRINGID_SERIAL</span><span class="p">,</span>
    <span class="n">STRINGID_CONFIG_HS</span><span class="p">,</span>
    <span class="n">STRINGID_CONFIG_LS</span><span class="p">,</span>
    <span class="n">STRINGID_INTERFACE</span><span class="p">,</span>
    <span class="n">STRINGID_MAX</span>
<span class="p">};</span>
</code></pre></div>

<p>Config value is the number of endpoints. After that, we have paths relative to GadgetFS. When mounted, there is only <em>USB_DEV</em>, endpoints appears after the first configuration (ep0). Name of endpoints is dependent of the driver implementation.</p>

<p>Structures and static variables :</p>

<div class="codehilite"><pre><span></span><code><span class="k">struct</span> <span class="n">io_thread_args</span> <span class="p">{</span>
    <span class="kt">unsigned</span> <span class="n">stop</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">fd_in</span><span class="p">,</span> <span class="n">fd_out</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">io_thread_args</span> <span class="n">thread_args</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_string</span> <span class="n">stringtab</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="n">STRINGID_MANUFACTURER</span><span class="p">,</span> <span class="s">"MyOwnGadget"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_PRODUCT</span><span class="p">,</span>      <span class="s">"Custom gadget"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_SERIAL</span><span class="p">,</span>       <span class="s">"0001"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_CONFIG_HS</span><span class="p">,</span>    <span class="s">"High speed configuration"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_CONFIG_LS</span><span class="p">,</span>    <span class="s">"Low speed configuration"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_INTERFACE</span><span class="p">,</span>    <span class="s">"Custom interface"</span><span class="p">,</span> <span class="p">},</span>
    <span class="p">{</span> <span class="n">STRINGID_MAX</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_gadget_strings</span> <span class="n">strings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">language</span> <span class="o">=</span> <span class="mh">0x0409</span><span class="p">,</span> <span class="cm">/* en-us */</span>
    <span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">stringtab</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">ep_descriptor_in</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="n">ep_descriptor_out</span><span class="p">;</span>
</code></pre></div>

<p>The main thing here is the description of strings inside <em>stringtag</em> that will be parsed by usbstring functions.</p>

<div class="codehilite"><pre><span></span><code><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">send_size</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usb_config_descriptor</span> <span class="n">config</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usb_config_descriptor</span> <span class="n">config_hs</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usb_device_descriptor</span> <span class="n">device_descriptor</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usb_interface_descriptor</span> <span class="n">if_descriptor</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">init_config</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">cp</span><span class="p">;</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">USB_DEV</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="o">|</span><span class="n">O_SYNC</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to open %s (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">USB_DEV</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">init_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_config</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE_SIZE</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_DEVICE</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bDeviceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_COMM</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bDeviceSubClass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bDeviceProtocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">//device_descriptor.bMaxPacketSize0 = 255; Set by driver</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">idVendor</span> <span class="o">=</span> <span class="mh">0xAA</span><span class="p">;</span> <span class="c1">// My own id</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">idProduct</span> <span class="o">=</span> <span class="mh">0xBB</span><span class="p">;</span> <span class="c1">// My own id</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bcdDevice</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span> <span class="c1">// Version</span>
    <span class="c1">// Strings</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">iManufacturer</span> <span class="o">=</span> <span class="n">STRINGID_MANUFACTURER</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">iProduct</span> <span class="o">=</span> <span class="n">STRINGID_PRODUCT</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">iSerialNumber</span> <span class="o">=</span> <span class="n">STRINGID_SERIAL</span><span class="p">;</span>
    <span class="n">device_descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// Only one configuration</span>

    <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">;</span>
    <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">;</span>
    <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">;</span>
    <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="c1">// HS size</span>

    <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT_SIZE</span><span class="p">;</span>
    <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_ENDPOINT</span><span class="p">;</span>
    <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_ENDPOINT_XFER_BULK</span><span class="p">;</span>
    <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">wMaxPacketSize</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span> <span class="c1">// HS size</span>

    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">if_descriptor</span><span class="p">);</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_INTERFACE</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bAlternateSetting</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bInterfaceClass</span> <span class="o">=</span> <span class="n">USB_CLASS_COMM</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bInterfaceProtocol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">if_descriptor</span><span class="p">.</span><span class="n">iInterface</span> <span class="o">=</span> <span class="n">STRINGID_INTERFACE</span><span class="p">;</span>

    <span class="n">config_hs</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config_hs</span><span class="p">);</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CONFIG</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">wTotalLength</span> <span class="o">=</span> <span class="n">config_hs</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span>
        <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span> <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span> <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bLength</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">bConfigurationValue</span> <span class="o">=</span> <span class="n">CONFIG_VALUE</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">iConfiguration</span> <span class="o">=</span> <span class="n">STRINGID_CONFIG_HS</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_CONFIG_ATT_ONE</span> <span class="o">|</span> <span class="n">USB_CONFIG_ATT_SELFPOWER</span><span class="p">;</span>
    <span class="n">config_hs</span><span class="p">.</span><span class="n">bMaxPower</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">config</span><span class="p">.</span><span class="n">bLength</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
    <span class="n">config</span><span class="p">.</span><span class="n">bDescriptorType</span> <span class="o">=</span> <span class="n">USB_DT_CONFIG</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">wTotalLength</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span>
        <span class="n">if_descriptor</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span> <span class="n">ep_descriptor_in</span><span class="p">.</span><span class="n">bLength</span> <span class="o">+</span> <span class="n">ep_descriptor_out</span><span class="p">.</span><span class="n">bLength</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">bNumInterfaces</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">bConfigurationValue</span> <span class="o">=</span> <span class="n">CONFIG_VALUE</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">iConfiguration</span> <span class="o">=</span> <span class="n">STRINGID_CONFIG_LS</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">bmAttributes</span> <span class="o">=</span> <span class="n">USB_CONFIG_ATT_ONE</span> <span class="o">|</span> <span class="n">USB_CONFIG_ATT_SELFPOWER</span><span class="p">;</span>
    <span class="n">config</span><span class="p">.</span><span class="n">bMaxPower</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">FETCH</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">if_descriptor</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_in</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_out</span><span class="p">);</span>

    <span class="n">FETCH</span><span class="p">(</span><span class="n">config_hs</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">if_descriptor</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_in</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_out</span><span class="p">);</span>

    <span class="n">FETCH</span><span class="p">(</span><span class="n">device_descriptor</span><span class="p">);</span>

    <span class="c1">// Configure ep0</span>
    <span class="n">send_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">cp</span><span class="o">-</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">init_config</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">init_config</span><span class="p">,</span> <span class="n">send_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">send_size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Write error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"ep0 configured</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">handle_ep0</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

<span class="nl">end</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>The main function. We build the descriptors and send them to <em>ep0</em>.
 It's needed to send both low/full speed (USB 1) and high speed (USB 2) 
configurations. Here, they are quite the same. We have only one 
interface with two endpoints, one for <em>in</em>, and one for <em>out</em>.
 Descriptors are sent as a big char array that must starts by an 
uint32_t tag set to 0. All values are expressed in little endian.</p>

<p>ep0 function :</p>

<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_ep0</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">nevents</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">fd_set</span> <span class="n">read_set</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usb_gadgetfs_event</span> <span class="n">events</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_set</span><span class="p">);</span>
        <span class="n">FD_SET</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_set</span><span class="p">);</span>

        <span class="n">select</span><span class="p">(</span><span class="n">fd</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">events</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Read error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>        
        <span class="p">}</span>

        <span class="n">nevents</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"%d event(s)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">nevents</span><span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">nevents</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">type</span><span class="p">)</span>
            <span class="p">{</span>
            <span class="k">case</span> <span class="nl">GADGETFS_CONNECT</span><span class="p">:</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"EP0 CONNECT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">GADGETFS_DISCONNECT</span><span class="p">:</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"EP0 DISCONNECT</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">GADGETFS_SETUP</span><span class="p">:</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"EP0 SETUP</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                <span class="n">handle_setup_request</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">events</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">u</span><span class="p">.</span><span class="n">setup</span><span class="p">);</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="nl">GADGETFS_NOP</span><span class="p">:</span>
            <span class="k">case</span> <span class="nl">GADGETFS_SUSPEND</span><span class="p">:</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="nl">end</span><span class="p">:</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>This one receives events and handle them. The most important are 
setup requests, which are requests that kernel cannot full handle by 
itself (or notice userspace).</p>

<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_setup_request</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_ctrlrequest</span><span class="o">*</span> <span class="n">setup</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="kt">uint8_t</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
    <span class="n">pthread_t</span> <span class="kr">thread</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Setup request %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequest</span><span class="p">)</span>
    <span class="p">{</span>
    <span class="k">case</span> <span class="nl">USB_REQ_GET_DESCRIPTOR</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
            <span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">case</span> <span class="nl">USB_DT_STRING</span><span class="p">:</span>
                <span class="n">printf</span><span class="p">(</span><span class="s">"Get string id #%d (max length %d)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
                    <span class="n">setup</span><span class="o">-&gt;</span><span class="n">wLength</span><span class="p">);</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">usb_gadget_get_string</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">strings</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
                <span class="c1">// Error </span>
                <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"String not found !!</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">else</span>
                <span class="p">{</span>
                    <span class="n">printf</span><span class="p">(</span><span class="s">"Found %d bytes</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="n">write</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
                <span class="k">return</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Cannot return descriptor %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
        <span class="p">}</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">USB_REQ_SET_CONFIGURATION</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">!=</span> <span class="n">USB_DIR_OUT</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Bad dir</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">goto</span> <span class="n">stall</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nl">CONFIG_VALUE</span><span class="p">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Set config value</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_args</span><span class="p">.</span><span class="n">stop</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">thread_args</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
                <span class="n">usleep</span><span class="p">(</span><span class="mi">200000</span><span class="p">);</span> <span class="c1">// Wait for termination</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">thread_args</span><span class="p">.</span><span class="n">fd_in</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">status</span> <span class="o">=</span> <span class="n">init_ep</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">thread_args</span><span class="p">.</span><span class="n">fd_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thread_args</span><span class="p">.</span><span class="n">fd_out</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">else</span>
                <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">thread_args</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
                <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="kr">thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">io_thread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thread_args</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Disable threads</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
            <span class="n">thread_args</span><span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Unhandled configuration value %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">setup</span><span class="o">-&gt;</span><span class="n">wValue</span><span class="p">);</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>        
        <span class="c1">// Just ACK</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">read</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">USB_REQ_GET_INTERFACE</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"GET_INTERFACE</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">write</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">USB_REQ_SET_INTERFACE</span><span class="p">:</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"SET_INTERFACE</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
        <span class="n">ioctl</span> <span class="p">(</span><span class="n">thread_args</span><span class="p">.</span><span class="n">fd_in</span><span class="p">,</span> <span class="n">GADGETFS_CLEAR_HALT</span><span class="p">);</span>
        <span class="n">ioctl</span> <span class="p">(</span><span class="n">thread_args</span><span class="p">.</span><span class="n">fd_out</span><span class="p">,</span> <span class="n">GADGETFS_CLEAR_HALT</span><span class="p">);</span>
        <span class="c1">// ACK</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">read</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">stall</span><span class="p">:</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">"Stalled</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>
    <span class="c1">// Error</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">setup</span><span class="o">-&gt;</span><span class="n">bRequestType</span> <span class="o">&amp;</span> <span class="n">USB_DIR_IN</span><span class="p">)</span>
        <span class="n">read</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">else</span>
        <span class="n">write</span> <span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>A bad response within this function can stall the endpoint. Two 
principle functions are to send back strings (not managed by driver) and
 starts/stop io_thread().</p>

<p>The <em>init_ep()</em> function is pretty simple. It justs sends endpoint descriptors (in low/full and high speed configuration). Like <em>ep0</em>, it must starts with an uint32_t tag of value 1 :</p>

<div class="codehilite"><pre><span></span><code><span class="k">static</span> <span class="kt">int</span> <span class="nf">init_ep</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span> <span class="n">fd_in</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">fd_out</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint8_t</span> <span class="n">init_config</span><span class="p">[</span><span class="mi">2048</span><span class="p">];</span>
    <span class="kt">uint8_t</span><span class="o">*</span> <span class="n">cp</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">send_size</span><span class="p">;</span>

    <span class="c1">// Configure ep1 (low/full speed + high speed)</span>
    <span class="o">*</span><span class="n">fd_in</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">USB_EPIN</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fd_in</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to open %s (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">USB_EPIN</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">init_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_config</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_in</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_in</span><span class="p">);</span>

    <span class="n">send_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">cp</span><span class="o">-</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">init_config</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">fd_in</span><span class="p">,</span> <span class="n">init_config</span><span class="p">,</span> <span class="n">send_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">send_size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Write error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"ep1 configured</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Configure ep2 (low/full speed + high speed)</span>
    <span class="o">*</span><span class="n">fd_out</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">USB_EPOUT</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">fd_out</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to open %s (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">USB_EPOUT</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span><span class="o">*</span><span class="p">)</span><span class="n">init_config</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">init_config</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_out</span><span class="p">);</span>
    <span class="n">FETCH</span><span class="p">(</span><span class="n">ep_descriptor_out</span><span class="p">);</span>

    <span class="n">send_size</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">cp</span><span class="o">-</span><span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="n">init_config</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span><span class="p">(</span><span class="o">*</span><span class="n">fd_out</span><span class="p">,</span> <span class="n">init_config</span><span class="p">,</span> <span class="n">send_size</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">send_size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Write error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"ep2 configured</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">end</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Finally, the <em>io_thread()</em> that responds to host requests. 
Here, I use select, but it seems not to be handled by driver, I/Os are 
just blocking, but it could be necessary if we want to stop thread.</p>

<div class="codehilite"><pre><span></span><code><span class="cm">/*</span>
<span class="cm"> * Respond to host requests</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="nf">io_thread</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">io_thread_args</span><span class="o">*</span> <span class="n">thread_args</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">io_thread_args</span><span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>
    <span class="n">fd_set</span> <span class="n">read_set</span><span class="p">,</span> <span class="n">write_set</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">timeval</span> <span class="n">timeout</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">max_read_fd</span><span class="p">,</span> <span class="n">max_write_fd</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

    <span class="n">max_read_fd</span> <span class="o">=</span> <span class="n">max_write_fd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span> <span class="o">&gt;</span> <span class="n">max_write_fd</span><span class="p">)</span> <span class="n">max_write_fd</span> <span class="o">=</span> <span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span> <span class="o">&gt;</span> <span class="n">max_read_fd</span><span class="p">)</span> <span class="n">max_read_fd</span>  <span class="o">=</span> <span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span><span class="p">;</span>

    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_set</span><span class="p">);</span>
        <span class="n">FD_SET</span><span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_set</span><span class="p">);</span>
        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">timeout</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="c1">// 10ms</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">max_read_fd</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">timeout</span><span class="p">);</span>

        <span class="c1">// Timeout</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>

        <span class="c1">// Error</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">read</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Read %d bytes : %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
        <span class="k">else</span>
            <span class="n">printf</span><span class="p">(</span><span class="s">"Read error %d(%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

        <span class="n">FD_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_set</span><span class="p">);</span>
        <span class="n">FD_SET</span><span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_set</span><span class="p">);</span>

        <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">max_write_fd</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">write_set</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

        <span class="c1">// Error</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>

        <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"My name is USBond !"</span><span class="p">);</span>

        <span class="n">ret</span> <span class="o">=</span> <span class="n">write</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>

        <span class="n">printf</span><span class="p">(</span><span class="s">"Write status %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">close</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span><span class="p">);</span>
    <span class="n">close</span> <span class="p">(</span><span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span><span class="p">);</span>

    <span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_in</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">thread_args</span><span class="o">-&gt;</span><span class="n">fd_out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h2>4. host side</h2>

<p>Host part is very easy to implement. This part can be handled by <a href="http://libusb.info/">libusb</a> for a more complete and generic code.</p>

<div class="codehilite"><pre><span></span><code><span class="cp">#include</span> <span class="cpf">&lt;sys/ioctl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;sys/stat.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;linux/usbdevice_fs.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;linux/usb/ch9.h&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;stdint.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp"></span>

<span class="cp">#define USB_DEV "/proc/bus/usb/001/002"</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">err</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usbdevfs_connectinfo</span> <span class="n">connectinfo</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">usbdevfs_bulktransfer</span> <span class="n">transfert</span><span class="p">;</span>
    <span class="kt">uint32_t</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Build %s @ %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">__DATE__</span><span class="p">,</span> <span class="n">__TIME__</span><span class="p">);</span>

    <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="n">USB_DEV</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fd</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Unable to open %s (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">USB_DEV</span><span class="p">);</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Device opened</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Optional get information</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">USBDEVFS_CONNECTINFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">connectinfo</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"USBDEVFS_CONNECTINFO error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"devnum %d, slow %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
           <span class="n">connectinfo</span><span class="p">.</span><span class="n">devnum</span><span class="p">,</span> <span class="n">connectinfo</span><span class="p">.</span><span class="n">slow</span><span class="p">);</span>

    <span class="c1">// Claim interface 0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">USBDEVFS_CLAIMINTERFACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"USBDEVFS_CLAIMINTERFACE error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Interface claimed</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="c1">// Send data on ep2out</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">"What is your name ?"</span><span class="p">);</span>

    <span class="n">transfert</span><span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">USBDEVFS_BULK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transfert</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"USBDEVFS_BULK 1 error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Transfert 1 OK %d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

    <span class="c1">// Receive data on ep1in</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">ep</span> <span class="o">=</span> <span class="n">USB_DIR_IN</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">);</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">transfert</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">USBDEVFS_BULK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">transfert</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"USBDEVFS_BULK 2 error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"Transfert 2 OK %d %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>

    <span class="c1">// Release interface 0</span>
    <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">USBDEVFS_RELEASEINTERFACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">"USBDEVFS_RELEASEINTERFACE error %d (%m)</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">"Interface released</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span>

    <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">end</span><span class="p">:</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>

    <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>To start, we claim an interface. This ioctl fully handled in host 
side driver (nothing is send to device). After that, a simple 
send/receive protocol. Finally we release interface. be carreful, <em>USB_DEV</em> path change when the device is disconnected.</p>

<h2>5. Conclusion</h2>

<p>The full code can be found <a href="http://soutade.fr/files/gadgetfs.tar.gz">on my server</a>. This basic example can be extended a lot : isochronous, asynch requests, streams (USB 3). Enjoy !</p>
</div>
	  <footer class="post_footer">
	    <a href="http://blog.soutade.fr/post/2016/07/create-your-own-usb-gadget-with-gadgetfs.html">permalink</a>
	  </footer>
    
	<div class="feed">
	  <a href="https://blog.soutade.fr/rss.xml"><img alt="RSS feeds" src="Create%20your%20own%20USB%20gadget%20with%20GadgetFS-Dateien/rss.png"> RSS</a><a href="https://blog.soutade.fr/atom.xml"><img alt="Atom feeds" src="Create%20your%20own%20USB%20gadget%20with%20GadgetFS-Dateien/atom.png"> Atom</a>
	</div>
      </nav>
      <p style="text-align:center">Généré avec <a href="http://indefero.soutade.fr/p/dynastie">Dynastie</a></p>
    </div>
  
</body></html>